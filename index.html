<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DEAR PLANT</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <!-- <link rel="stylesheet" href="css/calendar2.css"> -->
    <link rel="stylesheet" href="css/slick.css" type="text/css" /> 
    <link rel="stylesheet" href="css/templatemo-style.css">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR&display=swap');
    </style>
<!--
    
TemplateMo 560 Astro Motion

https://templatemo.com/tm-560-astro-motion

-->
</head>
<body>
    <img src="video/forest.png" loading="lazy" style="opacity: 0.85" alt="Image" height=100% id="bg-video">
    <!-- <video autoplay muted loop id="bg-video">
        <source src="video/main3.jpg" type="video/mp4">
    </video> -->
    <div class="page-container">
      <div class="container-fluid">
        <div class="row">
          <div class="col-xs-12">
            <div class="cd-slider-nav">
              <nav class="navbar navbar-expand-lg" id="tm-nav">
                <a class="nav-link" href="#0"><img src="img/dearplant_white.webp" loading="lazy" alt="Image" width="170" height=auto></a>
                <!-- <a class="navbar-brand" href="#">Dear Plant</a> -->
                  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-supported-content" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                  </button>
                  <div class="collapse navbar-collapse" id="navbar-supported-content">
                    <ul class="navbar-nav mb-2 mb-lg-0">
                      <li class="nav-item selected">
                        <!-- <a class="nav-link" href="#0" data-no="1">PLANT SOUND</a> -->
                        <!-- <div class="circle"></div> -->
                      </li>
                      <!-- <li class="nav-item">
                        <a class="nav-link" href="#0" data-no="2">MY DIARY</a>
                      </li> -->
                    </ul>
                  </div>
              </nav>
            </div>
          </div>          
        </div>        
      </div>

      <!-- Load Facebook SDK for JavaScript -->
      <div id="fb-root"></div>
      <script>
        window.fbAsyncInit = function() {
          FB.init({
            xfbml            : true,
            version          : 'v10.0'
          });
        };

        (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = 'https://connect.facebook.net/ko_KR/sdk/xfbml.customerchat.js';
        fjs.parentNode.insertBefore(js, fjs);
      }(document, 'script', 'facebook-jssdk'));</script>

      <!-- Your Chat Plugin code -->
      <div class="fb-customerchat"
        attribution="setup_tool"
        page_id="107060911473142">
      </div> 

      <div class="container-fluid tm-content-container">
        <ul class="cd-hero-slider mb-0 py-5">
          <li data-page-no="1">
            <!-- Image Carousel -->
            <div class="mx-auto position-relative gallery-container">
              <h4 class="text-center">식물 친구를 통해 자연을 느껴보세요.</h4>
              <h5 class="text-center">식물 친구와의 인터랙션에 따라 다양한 자연의 소리가 재생됩니다..</h5>
              <div class="text-center sound-button">
                <p href="#0" data-page-no="1" id="read" class="btn2 btn2-primary tm-intro-btn">
                  link sensor
                </p>
              </div> 
              <div class="mx-auto gallery-slider">
                <figure class="effect-julia item" id="forest1">
                    <img src="img/forest_small.webp" loading="lazy" alt="Image" id="forest1_img">
                    <figcaption>
                        <div>
                            <p>숲속으로 여행을 떠나보세요.</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
                <figure class="effect-julia item" id="river1">
                    <img src="img/river_small.webp" loading="lazy" alt="Image" id="river1_img">
                    <figcaption>
                        <div>
                            <p>강가로 여행을 떠나보세요.</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
                <figure class="effect-julia item" id="cricket1">
                    <img src="img/cricket_small.webp" loading="lazy" alt="Image" id="cricket1_img">
                    <figcaption>
                        <div>
                            <p>아늑한 시골로 여행을 떠나보세요.</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
                <figure class="effect-julia item" id="ocean1">
                    <img src="img/ocean_small.webp" loading="lazy" alt="Image" id="ocean1_img">
                    <figcaption>
                        <div>
                            <p>바다로 여행을 떠나보세요.</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
                <figure class="effect-julia item" id="bird1">
                    <img src="img/bird_small.webp" loading="lazy" alt="Image" id="bird1_img">
                    <figcaption>
                        <div>
                            <p>어여쁜 새가 바삐 움직이네요.</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
                <figure class="effect-julia item" id="bathtub1">
                    <img src="img/bathtub_small.webp" loading="lazy" alt="Image" id="bathtub1_img">
                    <figcaption>
                        <div>
                            <p>욕조에 누워 편안히 책 읽어보는 거 어때요?</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
                <figure class="effect-julia item" id="rain1">
                    <img src="img/rain_small.webp" loading="lazy" alt="Image" id="rain1_img">
                    <figcaption>
                        <div>
                            <p>지금 밖에 비가 오고 있어요.</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
                <figure class="effect-julia item" id="oven1">
                    <img src="img/oven_small.webp" loading="lazy" alt="Image" id="oven1_img">
                    <figcaption>
                        <div>
                            <p>어떤 요리가 완성되고 있을까요?</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
                <figure class="effect-julia item" id="campfire1">
                    <img src="img/fire_small.webp" loading="lazy" alt="Image" id="campfire1_img">
                    <figcaption>
                        <div>
                            <p>모닥불 소리를 들어보세요.</p>
                        </div>
                        <a href="#">View more</a>
                    </figcaption>
                </figure>
              </div>
            </div>
          </li>
          <!-- <li data-page-no="2" class="px-3">
            <div id='calendar'></div>   
          </li> -->
        </ul>
    </div>
    <div class="container-fluid">
      <footer class="row mx-auto tm-footer">
        <div class="col-md-6 px-0">
        </div>
        <div class="col-md-6 px-0 tm-footer-right">
          <p>Copyright 2021 Dearplants Inc. All rights reserved.</p>
        </div>
      </footer>
    </div>
  </div>
  <!-- Preloader, https://ihatetomatoes.net/create-custom-preloading-screen/ -->
  <div id="loader-wrapper">            
    <div id="loader"></div>
    <div class="loader-section section-left"></div>
    <div class="loader-section section-right"></div>
  </div>  
  <script src="js/moment.min.js"></script>
  <script src="js/jquery-3.5.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script src="js/slick.js"></script>
  <script src="js/templatemo-script.js"></script>
  <!-- <script src="js/calendar2.js"></script> -->
  <script>
    var deviceNamePrefix = 'PLITOR'
    var deviceName = 'PLITOR'
    var bleService = '0000ffe0-0000-1000-8000-00805f9b34fb'
    var bleCharacteristic = '0000ffe1-0000-1000-8000-00805f9b34fb'
    var bluetoothDeviceDetected
    var gattCharacteristic
    var pre_value = -1
    var sound_play = true
    var base_sound = new Audio('sound/base1.mp3');
    var nature_sound = new Audio('sound/forest1.mp3');
    var pre_click = "forest1_img"
    var hello_time = new Date('December 17, 2020 03:24:00')
    var tickle_time = new Date('December 17, 2020 03:24:00')
    base_sound.volume = 0.5

    document.getElementById(pre_click).style.border="5px solid #7b3f91"
  
    document.body.style.backgroundColor = "#000000";
    document.querySelector('#read').addEventListener('click', function() {
      if (isWebBluetoothEnabled()) { read() }
    })
  
    // document.querySelector('#start').addEventListener('click', function(event) {
    //   if (isWebBluetoothEnabled()) { sound_play = true }
    // })
  
    // document.querySelector('#stop').addEventListener('click', function(event) {
    //   if (isWebBluetoothEnabled()) { stop() }
    // })

    document.querySelector('#forest1').addEventListener('click', function() {
      nature_sound = new Audio('sound/forest1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "forest1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/forest.webp"
    })
    document.querySelector('#river1').addEventListener('click', function() {
      nature_sound = new Audio('sound/river1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "river1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/river.webp"
    })
    document.querySelector('#cricket1').addEventListener('click', function() {
      nature_sound = new Audio('sound/cricket1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "cricket1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/cricket.webp"
    })
    document.querySelector('#ocean1').addEventListener('click', function() {
      nature_sound = new Audio('sound/ocean1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "ocean1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/ocean.webp"
    })
    document.querySelector('#campfire1').addEventListener('click', function() {
      nature_sound = new Audio('sound/campfire1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "campfire1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/campfire.webp"
    })
    document.querySelector('#bird1').addEventListener('click', function() {
      nature_sound = new Audio('sound/bird1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "bird1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/bird.webp"
    })
    document.querySelector('#oven1').addEventListener('click', function() {
      nature_sound = new Audio('sound/oven1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "oven1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/oven.webp"
    })
    document.querySelector('#bathtub1').addEventListener('click', function() {
      nature_sound = new Audio('sound/bathtub1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "bathtub1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/bathtub.webp"
    })
    document.querySelector('#rain1').addEventListener('click', function() {
      nature_sound = new Audio('sound/rain1.mp3');
      document.getElementById(pre_click).style.border="none"
      pre_click = "rain1_img"
      document.getElementById(pre_click).style.border="5px solid #7b3f91"
      document.getElementById('bg-video').src="video/rain.webp"
    })
  
    function isWebBluetoothEnabled() {
      if (!navigator.bluetooth) {
        console.log('Web Bluetooth API is not available in this browser!')
        return false
      }
  
      return true
    }
  
    function getDeviceInfo() {
      let options = {
        optionalServices: [bleService],
        filters: [
          { "namePrefix": deviceNamePrefix }
        ]
      }
  
      console.log('Requesting any Bluetooth Device...')
      return navigator.bluetooth.requestDevice(options).then(device => {
        bluetoothDeviceDetected = device
        deviceName = device.name
      }).catch(error => {
        console.log('Argh! ' + error)
      })
    }
  
    function read() {
      return (bluetoothDeviceDetected ? Promise.resolve() : getDeviceInfo())
      .then(connectGATT)
      .then(_ => {
        console.log('Reading Value...')
        return gattCharacteristic[0].readValue()
      })
      .catch(error => {
        console.log('Waiting to start reading: ' + error)
      })
    }
  
    function connectGATT() {
      if (bluetoothDeviceDetected.gatt.connected && gattCharacteristic) {
        return Promise.resolve()
      }
  
      return bluetoothDeviceDetected.gatt.connect()
      .then(server => {
        console.log('Getting GATT Service...')
        return server.getPrimaryService(bleService)
      })
      .then(service => {
        console.log('Getting GATT Characteristic...')
        return service.getCharacteristics(bleCharacteristic)
      })
      .then(characteristic => {
        gattCharacteristic = characteristic
        console.log(gattCharacteristic)
        document.getElementById("read").innerHTML = "stop music"; 
        gattCharacteristic[0].addEventListener('characteristicvaluechanged',
            handleChangedValue)
        start()
      })
    }
  
    function handleChangedValue(event) {
      let value = event.target.value.getInt8(0)
      var now = new Date()
      console.log('> ' + now.getHours() + ':' + now.getMinutes() + ':' + now.getSeconds() + ' Value is ' + value)
      const Http = new XMLHttpRequest();
      
      if (value == 1) {
          nature_sound.animate({volume: 0.0}, 5000);
          nature_sound.pause()
          //document.getElementById("plant_talk").innerHTML = "나 목이 타들어갈 거 같아...물마시고 싶어<br>"; 
        } else if (value == 2){
          //document.getElementById("plant_talk").innerHTML = "<br>반가워:) 오랜만이야<br>"; 
          //base_sound.play()
          if (now - hello_time >= 300000){
            var url='https://api.dearplants.co.kr/chat/chatfuel/default_answer?state=2' + '&device_id=' + deviceName.slice(7);
            Http.open("GET", url);
            Http.send();
  
            Http.onreadystatechange = (e) => {
                console.log(Http.responseText)
            }
            hello_time = now
          }
          
        } else if (value == 3){
          //document.getElementById("plant_talk").innerHTML = "<br>히히 간지럽다>_< <br><br> 근데 나 목말라..물 좀 줄래?<br>";
          nature_sound.play()
          nature_sound.animate({volume: 1.0}, 5000);
          if (now - tickle_time >= 300000){
            var url='https://api.dearplants.co.kr/chat/chatfuel/default_answer?state=3'+ '&device_id=' + deviceName.slice(7);
            Http.open("GET", url);
            Http.send();
  
            Http.onreadystatechange = (e) => {
                console.log(Http.responseText)
            }
            tickle_time = now
          }
        } 
      }
    
    function start() {
      gattCharacteristic[0].startNotifications()
      .then(_ => {
        console.log('Start reading...')
        document.querySelector('#start').disabled = true
        document.querySelector('#stop').disabled = false
      })
      .catch(error => {
        console.log('[ERROR] Start: ' + error)
      })
    }
  
    function stop() {
      gattCharacteristic[0].stopNotifications()
      .then(_ => {
        console.log('Stop reading...')
        document.querySelector('#start').disabled = false
        document.querySelector('#stop').disabled = true
      })
      .catch(error => {
        console.log('[ERROR] Stop: ' + error)
      })
    }
  
    function stop() {
      base_sound.pause()
      fire_sound.pause()
      cricket_sound.pause()
      cricket_status = false
      fire_status = false
    }
  </script>
</body>
</html>